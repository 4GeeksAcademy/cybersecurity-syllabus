---

title: "EDR"  
subtitle: "Explorando los Sistemas EDR: Protección Avanzada y Detección de Amenazas para Empresas Modernas"  
tags: ["pentesting", "ciberseguridad", "blue-team"]  
authors: ["blindma1den", "lorenagubaira"]

---

# Sistemas EDR: qué son y cómo ayudan a proteger la seguridad de tu empresa

Un sistema EDR, acrónimo en inglés de *Endpoint Detection Response*, es un sistema de protección de los equipos e infraestructuras de la empresa. Combina el antivirus tradicional junto con herramientas de monitorización e inteligencia artificial para ofrecer una respuesta rápida y eficiente ante los riesgos y las amenazas más complejas. Gracias a esta conjunción de elementos y tecnologías permite detectar todos aquellos riesgos y amenazas que pueden provocar de forma silenciosa e inadvertida un incidente de seguridad, poniendo en riesgo la viabilidad de la empresa.

## Características de un sistema EDR

Un sistema EDR se caracteriza por aunar varios elementos de detección y de tecnologías, como por ejemplo, la inteligencia artificial y el Big Data, que permiten mejorar de forma programada y autónoma la detección y prevención de amenazas complejas, así como su posterior eliminación o mitigación. Aunque comparte cometidos con el antivirus tradicional, también conocido como EPP (*Endpoint Protection Platform*), como son la detección, identificación y la prevención de los efectos de *malware*, *exploits*, y en algunos casos, *ransomware*, esta herramienta además puede detectar amenazas avanzadas, como pueden ser *malware* de tipo polimórfico, vulnerabilidades *0-day*, ataques de ingeniería social, amenazas persistentes o APT, cuentas comprometidas, etc. En caso de detectar una amenaza o comportamiento anómalo, permite actuar de forma inmediata y casi automática para poder eliminar la amenaza o mitigar sus efectos.

Entre las aplicaciones y herramientas que incorpora, además del antivirus tradicional destacan:

- Herramientas de análisis apoyadas en el uso del aprendizaje automático (*machine learning*) para mejorar la detección de amenazas.
- *Sandbox*: el sistema virtual y aislado de pruebas para comprobar el comportamiento de los archivos descargados, por ejemplo.
- Escaneo de IOCs y reglas YARA, que permiten analizar y detectar las amenazas provocadas por amenazas complejas en tiempo real.
- El uso de listas blancas y negras de correos electrónicos, páginas web e IP.
- Interoperatibilidad e interacción con otras herramientas de seguridad, como SIEM, IPS/IDS o herramientas *antimalware*.

Los principales fabricantes del mercado de soluciones de seguridad ofrecen este tipo de sistemas en su portafolio de aplicaciones. En el caso de que una empresa no cuente con técnicos o con un Departamento de Informática, siempre tiene la posibilidad de subcontratar este servicio a un proveedor o contratar el servicio completo con el fabricante.

## Ventajas e inconvenientes

**Esta herramienta contiene una serie de ventajas y fortalezas frente a los antivirus tradicionales o EPP, como por ejemplo:**

- Recopila información exhaustiva y detallada de las características del dispositivo, como información del sistema operativo, del *hardware* o los procesos activos, entre otros datos.
- Permite recopilar y almacenar información de forma automática, así como crear patrones de detección automatizados, facilitando el trabajo de detección.
- Monitoriza la integridad de los sistemas y de los archivos de configuración claves, avisando en caso de modificación o acceso a los mismos por actores sospechosos.
- Permite localizar en un solo punto toda la información, posibilitando en caso de incidente la realización de una investigación de forma rápida.

**Por el contrario, esta herramienta muestra las siguientes debilidades:**

- En algunos casos no permite evaluar y comprobar aquellos dispositivos con sistemas operativos no soportados por la herramienta.
- Su configuración y puesta en marcha es más complicada de realizar que en el caso de un antivirus tradicional.
- Su uso puede provocar fatiga, debido al constante flujo de información y notificación de las propias alertas configuradas, así como de los falsos positivos y negativos que puedan darse.
- En ocasiones no permite monitorizar y analizar las conexiones cifradas.
- La inversión para implantar esta herramienta supone un importe más elevado que en el caso del antivirus tradicional o EPP.

## Diferencias respecto a los antivirus tradicionales

Respecto a los antivirus tradicionales, aunque han evolucionado de forma considerable en los últimos años gracias a estos, solo localizan amenazas de *malware* tradicional, es decir, virus, troyanos y gusanos. Son ineficaces ante la detección de ataques más complejos, en los que se mezclan la ingeniería social junto con los fallos humanos de los empleados, así como las técnicas más complejas (vulnerabilidades *0-day*, *ransomware*, cuentas comprometidas, amenazas persistentes, etc.) en las redes de la empresa, lo que puede provocar que sean más difíciles de detectar y controlar, con los consecuentes daños económicos y reputacionales para la empresa.

En definitiva, usar este tipo de herramientas, aunque puede suponer un gasto inicial más elevado, ofrece una serie de ventajas que permiten amortizar dicha inversión rápidamente gracias a sus características y tecnologías incorporadas, reduciendo así ostensiblemente los efectos perniciosos de ataques más sofisticados contra las infraestructuras digitales de la empresa. Si tienes dudas, llama al **017**, la **Línea de Ayuda en Ciberseguridad** de INCIBE. Expertos en la materia resolverán cualquier conflicto online relacionado con el uso de la tecnología y los dispositivos conectados.

### Los principales objetivos de este EDR son:

- Proporcionar un EDR de código abierto a la comunidad.
- Transparencia en las reglas de detección para que los analistas entiendan por qué se activó una regla.
- Ofrecer poderosas primitivas de detección a través de un motor de reglas flexible.
- Optimizar los procesos de respuesta a incidentes al reducir drásticamente el tiempo entre la detección y la recolección de artefactos.

El esquema global de funcionamiento es el siguiente, si bien el EDR puede funcionar también en modo *standalone*:

![EDR 1](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/edr1.es.png?raw=true)

**Fortalezas**

- Código abierto.
- Confía en Sysmon para todo el trabajo pesado (componente del kernel).
- Motor de detección muy potente pero también personalizable.
- Creado por un *incident responder* para que el resto hagan su trabajo más fácil.
- *Footprint* reducida (sin inyección de proceso).
- Puede coexistir con cualquier producto antivirus (se recomienda ejecutarlo junto con MS Defender).
- Diseñado para tener un alto rendimiento. Puede enriquecer y analizar fácilmente 4 millones de eventos al día por *endpoint* sin apenas impacto.
- Fácilmente integrable con otras herramientas (Splunk, ELK, MISP...)
- Integrado con el marco ATT&CK.

**Debilidades**

- Solo funciona en Windows.
- Detección limitada a lo que está disponible en el event log de Windows.
- Sin instrumentación de procesos (también es un punto fuerte ya que depende de puntos de vista).
- No hay GUI... todavía.
- Sin soporte para ETW (disponible en beta).

**Más info y URL del proyecto:** [https://github.com/0xrawsec/whids](https://github.com/0xrawsec/whids)

## Instalación

**Requisitos**

1. [Instalar Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)
2. Configurar Sysmon
    - Puede encontrar configuraciones optimizadas de Sysmon [aquí](https://github.com/0xrawsec/whids/tree/master/tools/sysmon)
    - Es obligatorio registrar cualquier ProcessCreate y ProcessTerminate.
3. Tome nota de la ruta a su binario Sysmon porque la necesitará más adelante.

**NB:** el filtrado de eventos se puede realizar al 100% con reglas Gene, así que no se moleste en crear una configuración Sysmon complicada.

**Recomendaciones previas a la instalación**

Para aprovechar al máximo WHIDS, es posible que desee mejorar su política de registro.

- [Habilitar el registro del módulo Powershell](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html)
- Creación del servicio de auditoría: 
    - Abre **gpedit.msc**.
    - Navega a **Configuración del equipo** > **Configuración de Windows** > **Configuración de seguridad** > **Configuración avanzada de la directiva de auditoría** > **Directivas del sistema de auditoría** > **Sistema** > **Auditar extensión del sistema de seguridad**.
    - Habilita la opción.
- Habilite la auditoría del sistema de archivos. Sysmon solo proporciona eventos FileCreate cuando se crean nuevos archivos, por lo que si desea/necesita registrar otro tipo de accesos (lectura, escritura, etc.) debe habilitar la auditoría FS.
    1. gpedit.msc -> Configuración del equipo -> Configuración de Windows -> Configuración de seguridad -> Configuración avanzada de políticas de auditoría -> Políticas de auditoría del sistema -> Acceso a objetos -> Auditoría del sistema de archivos-> Habilitar.
    2. Haga clic derecho en cualquier carpeta -> Propiedades -> Seguridad -> Avanzado -> Auditoría -> Agregar.
        1. Select a principal (ponga aquí el nombre del usuario/grupo para el que desea realizar la auditoría). Coloque el grupo **Todos** si desea registrar el acceso de cualquier usuario.
        2. Apply this tose utiliza para seleccionar el alcance de esta política de auditoría a partir de la carpeta que ha seleccionado.
        3. Basic permissionsseleccione los tipos de accesos para los que desea que se generen los registros
        4. Validar
    3. Los registros de auditoría del sistema de archivos aparecerán en el Securitycanal de registro.
- Si desea que se ejecute un **antivirus en sus terminales, conserve Microsoft Defender** , primero porque es un buen AV pero también porque registra alertas en un [canal de registro dedicado](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/troubleshoot-windows-defender-antivirus#windows-defender-av-ids) Microsoft-Windows-Windows Defender/Operational monitoreado por el EDR.

**Agente de punto final EDR (Whids.exe)**

Esta sección cubre la instalación del agente en el endpoint.

1. Descargue y extraiga la última versión de WHIDS [https://github.com/0xrawsec/whids/releases](https://github.com/0xrawsec/whids/releases)
2. Ejecutar manage.batcomo **administrador**.
3. Inicie la instalación seleccionando la opción adecuada.
4. Verifique que los archivos se hayan creado en el **directorio de instalación**
5. Edite el archivo de configuración seleccionando la opción apropiada en manage.bato usando su editor de texto preferido
6. Omita esto si lo ejecuta con una conexión a un administrador, porque las reglas se actualizarán automáticamente. Si no hay nada en el **directorio de reglas** , la herramienta será inútil, así que asegúrese de que haya algunas reglas **genéticas** allí. Algunas reglas están empaquetadas con WHIDS y se le pedirá que elija si desea instalarlas o no. Si desea las últimas reglas actualizadas, puede obtenerlas [aquí](https://raw.githubusercontent.com/0xrawsec/gene-rules/master/compiled.gen) (tome las **compiladas** )
7. Inicie los **servicios** desde la opción adecuada manage.bato simplemente reinicie ( =**opción preferida**, de lo contrario, algunos campos de enriquecimiento estarán incompletos y generarán alertas falsas)
8. Si configuraste un **administrador** no olvides ejecutarlo para recibir alertas y volcados.

**NB:** En el momento de la instalación, el **servicio Sysmon** dependerá *del* **servicio WHIDS** para que estemos seguros de que EDR se ejecute antes de que Sysmon **comience** a generar algunos eventos.

**Administrador de EDR**

El administrador de EDR se puede instalar en varias plataformas; se proporcionan archivos binarios prediseñados para Windows, Linux y Darwin.

1. Cree un certificado TLS si es necesario para conexiones HTTPS.
2. Cree un archivo de configuración (hay un argumento de línea de comando para generar una configuración básica).
3. Ejecute el binario.

**Ejemplos de configuración**

Visite [doc/configuration.md](https://github.com/0xrawsec/whids/blob/master/doc/configuration.md)

**Documentación adicional**

- [Documentación de la API REST de Endpoint Manager](https://validator.swagger.io/?url=https://raw.githubusercontent.com/0xrawsec/whids/master/doc/admin.openapi.json)
- [Cómo escribir reglas](https://rawsec.lu/doc/gene/1.6/)
- [Obtener reglas de detección de EDR](https://github.com/0xrawsec/gene-rules)
- [Descripción general del enriquecimiento de eventos](https://github.com/0xrawsec/whids/blob/master/doc/events-table.md)

**Problemas conocidos**

- No funciona correctamente cuando se ejecuta desde un recurso compartido de red **asignado como unidad de red** (este caso impide que los whids se identifiquen y, por lo tanto, generen algo de ruido). Ejemplo: si \\vbox\testestá montado como Z:unidad, la ejecución Z:\whids.exe **no funcionará,** mientras que la ejecución \\vbox\test\whids.exesí lo haría.

**Hoja de ruta hasta el próximo lanzamiento**

- Encuentra un nuevo nombre para el proyecto porque todos estamos de acuerdo en que apesta.
- Mejor integración de sysmon (configuración, implementación, actualización).
- Configuración del punto final desde el administrador
- Gestión de herramientas (actualización, instalación), como OSQuery.
- Refactorización y optimización de código.
- Implementar un monitor de desempeño.
- Deshacerse de cualquier configuración en el disco.
- Implementar capacidades de gestión del COI
- Soporte ETW.
- Documentación automática (OpenAPI) y prueba de la API del administrador.
- Proporcionar información del sistema de punto final en el administrador.
- Implementar reglas procesables.
- Proporcionar gestión de archivos canary.
- Comandos integrados que serán ejecutados por los puntos finales.
- Proporcionar informes de respuesta a incidentes sobre puntos finales.
- Mejora general de la API del administrador.
- Proporcionar secuencias de eventos para que un cliente pueda recibir eventos en tiempo real.
- Estandarizar encabezados HTTP.
- Proporcione una biblioteca de Python para interactuar con el administrador de EDR ([https://github.com/0xrawsec/pywhids](https://github.com/0xrawsec/pywhids) )

**Registro de cambios**

**v1.7**

- Nueva API HTTP administrativa con las siguientes características:
    - Administrar puntos finales (enumerar, crear, eliminar).
    - Obtenga estadísticas básicas sobre el gerente.
    - Ejecute comandos en endpoints y obtenga resultados.
        - Puede soltar archivos antes de la ejecución, para ejecutar binarios/scripts que no estén presentes en el punto final. Los archivos descartados se eliminan después de ejecutar el comando.
        - Puede recuperar archivos (después de la ejecución del comando), para recuperar los resultados del comando.
    - Recopile archivos de puntos finales con fines forenses.
    - Contener/descontener puntos finales restringiendo cualquier tráfico de red excepto la comunicación con el administrador.
    - Consultar registros de puntos finales.
    - Consultar alertas de puntos finales.
    - Gire sobre una marca de tiempo y recupere registros/alertas alrededor de ese giro de tiempo.
    - Acceder al informe del punto final.
        - Puntuación (**relativa a cada entorno**) que permite ordenar los puntos finales y detectar los que se comportan de manera diferente a los demás.
        - Alertas/TTP observados en un período de tiempo determinado.
    - Administrar reglas (enumerar, crear, actualizar, guardar, eliminar).
- Integración con Sysmon v12 y v13.
    - Integrar eventos ClipboardData.
        - Coloque el contenido de los datos del portapapeles dentro del evento para permitir la creación de reglas sobre el contenido del portapapeles.
    - Integrar eventos de ProcessTampering
        - Enriquecer el evento con una puntuación diferente entre la sección .text en el disco y en la memoria.
- Se implementó la fijación de certificados en el cliente para mejorar la seguridad del canal de comunicación entre los puntos finales y el servidor de administración.
- Capacidades de filtrado de registros, lo que permite recopilar eventos contextuales. El filtrado de registros se logra mediante la creación de reglas de filtrado Gene (consulte [la documentación de Gene](https://github.com/0xrawsec/gene) ).
- Archivos de configuración en formato TOML para una mejor legibilidad
- Mejor protección del directorio de instalación.

**Trabajo relacionado**

- EDR basado en Sysmon escrito en PowerShell: [https://github.com/ion-storm/sysmon-edr](https://github.com/ion-storm/sysmon-edr)
- Comodo Open Source EDR con componentes de usuario y kernel: [https://github.com/ComodoSecurity/openedr](https://github.com/ComodoSecurity/openedr)
- Sysmon X: [https://github.com/marcosd4h/sysmonx](https://github.com/marcosd4h/sysmonx)