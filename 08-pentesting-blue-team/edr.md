---
title: "EDR"
subtitle: "Exploring EDR Systems: Advanced Protection and Threat Detection for Modern Enterprises"
tags: ["pentesting", "cybersecurity", "blue-team"]
authors: ["blindma1den", "lorenagubaira"]

---

## EDR systems: what they are and how they help to protect the security of your company

An EDR system, which stands for *Endpoint Detection Response*, is a system for protecting company equipment and infrastructure. It combines traditional antivirus with monitoring tools and artificial intelligence to provide a fast and efficient response to the most complex risks and threats. Thanks to this combination of elements and technologies, it can detect all those risks and threats that can silently and inadvertently provoke a security incident, putting the company's viability at risk.

## Characteristics of an EDR system

An EDR system is characterized by the combination of several detection elements and technologies, such as artificial intelligence and Big Data, which allow programmed and autonomous improvement in the detection and prevention of complex threats, as well as their subsequent elimination or mitigation. Although it shares tasks with the traditional antivirus, also known as EPP (*Endpoint Protection Platform*), such as detection, identification, and prevention of the effects of *malware*, *exploits*, and in some cases, *ransomware*, this tool can also detect advanced threats, such as polymorphic *malware*, *0-day* vulnerabilities, social engineering attacks, persistent threats or APTs, compromised accounts, etc. In the event of detecting a threat or anomalous behavior, it allows immediate and almost automatic action to eliminate the threat or mitigate its effects.

Among the applications and tools it incorporates, in addition to the traditional antivirus, the following stand out:

- Analysis tools supported by the use of automatic learning (*machine learning*) to improve threat detection.
- Sandbox: the virtual and isolated test system to check the behavior of downloaded files, for example.
- IOCs scanning and YARA rules, which allow to analyze and detect threats caused by complex threats in real-time.
- The use of whitelisting and blacklisting of emails, web pages and IPs.
- Interoperability and interaction with other security tools, such as SIEM, IPS/IDS, or *antimalware* tools.

The main manufacturers in the security solutions market offer this type of system in their application portfolio. If a company does not have technicians or an IT Department, it always has the possibility of outsourcing this service to a supplier or contracting the complete service with the manufacturer.

## Advantages and disadvantages

**This tool contains several advantages and strengths compared to traditional antivirus or EPP, such as:**

- It collects exhaustive and detailed information about the device's characteristics, such as information about the operating system, *hardware*, and active processes, among other data.
- It allows to collection and storage of information automatically, as well as to creation of automated detection patterns, facilitating the detection work.
- It monitors the integrity of systems and key configuration files, alerting in case of modification or access to them by suspicious actors.
- It makes it possible to locate all the information in a single point, making it possible to carry out an investigation quickly in the event of an incident.

**On the other hand, this tool has the following weaknesses:**

- In some cases, it does not allow us to evaluate and check those devices with operating systems not supported by the tool.
- Its configuration and start-up are more complicated to perform than in the case of a traditional antivirus.
- Its use can cause fatigue, due to the constant flow of information and notification of the configured alerts, as well as the false positives and negatives that may occur.
- Sometimes it does not allow monitoring and analysis of encrypted connections.
- The investment to implement this tool is higher than in the case of traditional antivirus or EPP.

## Differences with respect to traditional antivirus

Although traditional antivirus tools have evolved considerably in recent years, they only detect traditional *malware* threats, i.e. viruses, Trojans, and worms. They are ineffective in detecting more complex attacks, in which social engineering is mixed with the human failures of employees, as well as the most complex techniques (vulnerabilities *0-day*, *ransomware*, compromised accounts, persistent threats, etc.) in the company's networks, which can make them more difficult to detect and control, with the consequent economic and reputational damage for the company.

In short, using this type of tool, although it may entail a higher initial cost, offers a series of advantages that allow the investment to be quickly amortized thanks to its features and built-in technologies, thus ostensibly reducing the pernicious effects of more sophisticated attacks against the company's digital infrastructures. If you have any doubts, call **017**, INCIBE's **Cybersecurity Helpline**. Experts in the field will resolve any online conflict related to the use of technology and connected devices.

### The main objectives of this EDR are:

- Provide an open-source EDR to the community.
- Transparency of detection rules so that analysts understand why a rule was triggered
- Deliver powerful detection primitives through a flexible rule engine.
- Optimizing incident response processes by drastically reducing the time between detection and artifact collection.

The overall scheme of operation is as follows, although EDR can also operate in *standalone* mode:

![EDR 1](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/edr1.png?raw=true)

**Strengths**

- Open Source.
- Relies on Sysmon for all the heavy lifting (kernel component).
- Very powerful but also customizable detection engine.
- Created by an *incident responder* to make the rest do their job easier.
- Reduced *Footprint* (no process injection).
- Can coexist with any antivirus product.(recommended to run together with MS Defender).
- Designed for high performance. Can easily enrich and analyze 4 million events per day per *endpoint* with little to no impact.
- Easily integrated with other tools (Splunk, ELK, MISP...)
- Integrated with ATT&CK framework.

**Weaknesses**

- Only works on Windows.
- Detection is limited to what is available in the Windows event log.
- No process instrumentation (also a strength as it relies on views).
- No GUI... yet.
- No ETW support (available in beta).

**More info and project URL:** [https://github.com/0xrawsec/whids](https://github.com/0xrawsec/whids)

## Installation

**Requirements**

1. [Install Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)
2. Configure Sysmon
    - You can find optimized Sysmon configurations [here](https://github.com/0xrawsec/whids/tree/master/tools/sysmon
    - It is mandatory to register any ProcessCreate and ProcessTerminate.
3. Take note of the path to your Sysmon binary because you will need it later on.

**NB:** Event filtering can be done 100% with Gene rules, so don't bother creating a complicated Sysmon configuration.

**Pre-installation recommendations**

To get the most out of WHIDS, you may want to enhance your logging policy.

- [Enable Powershell module logging](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html)
- Creating the audit service:
    - Open **gpedit.msc**.
    - Navigate to **Computer Configuration** > **Windows Settings** > **Security Settings** > **Advanced Audit Policy Configuration** > **System Audit Policies** > **System** > **Audit Security System Extension**.
    - Enable.
- Enable file system auditing. Sysmon only provides FileCreate events when new files are created, so if you want/need to log other types of accesses (read, write, etc.) you must enable FS auditing.
    1. gpedit.msc -> Computer Configuration -> Windows Settings -> Security Settings -> Advanced Audit Policy Configuration -> System Audit Policies -> Object Access -> File System Audit-> Enable
    2. Right-click on any folder -> Properties -> Security -> Advanced -> Audit -> Add.
        1. Select a principal (put here the name of the user/group for which you want to perform the audit). Set the group to **All** if you want to log access for any user.
        2. Apply this cough is used to select the scope of this audit policy from the folder you have selected.
        3. Basic permissions select the types of accesses for which you want the logs to be generated.
        4. Validate
    3. The file system audit logs will appear in the Security logging channel.
- If you want an **antivirus running on your endpoints, keep Microsoft Defender**, first because it is a good AV but also because it logs alerts in a [dedicated log channel](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/troubleshoot-windows-defender-antivirus#windows-defender-av-ids) Microsoft-Windows-Windows Defender/Operational monitored by the EDR.

**EDR Endpoint Agent (Whids.exe)**.

This section covers the installation of the agent on the endpoint.

1. Download and extract the latest version of WHIDS [https://github.com/0xrawsec/whids/releases](https://github.com/0xrawsec/whids/releases)
2. Run manage.bat as **administrator**.
3. Start the installation by selecting the appropriate option.
4. Verify that the files have been created in the **installation directory**.
5. Edit the configuration file by selecting the appropriate option in manage.bato using your preferred text editor.
6. Skip this if you run it with a connection to an administrator because the rules will be updated automatically. If there is nothing in the **rules directory**, the tool will be useless, so make sure there are some **generic** rules there. Some rules are packaged with WHIDS and you will be prompted to choose whether you want to install them or not. If you want the latest updated rules, you can get them [here](https://raw.githubusercontent.com/0xrawsec/gene-rules/master/compiled.gen) (take the **compiled** ones).
7. Start the **services** from the appropriate manage.bato option just restart (**preferred option**, otherwise some enrichment fields will be incomplete and generate false alerts)
8. If you configured an **administrator** don't forget to run it to receive alerts and dumps.

**NB:** At installation time, the **Sysmon service** will depend on *the* **WHIDS service** so that we are sure that EDR is running before Sysmon **starts** to generate some events.

**EDR Manager**

The EDR manager can be installed on various platforms; prebuilt binaries are provided for Windows, Linux, and Darwin.

1. Create a TLS certificate if required for HTTPS connections.
2. Create a configuration file (there is a command line argument to generate a basic configuration).
3. Run the binary.

**Examples of configuration**.

Visit [doc/configuration.md](https://github.com/0xrawsec/whids/blob/master/doc/configuration.md)

**Additional documentation**

- [Endpoint Manager REST API documentation](https://validator.swagger.io/?url=https://raw.githubusercontent.com/0xrawsec/whids/master/doc/admin.openapi.json)
- [How to write rules](https://rawsec.lu/doc/gene/1.6/)
- [Getting EDR Detection Rules](https://github.com/0xrawsec/gene-rules)
- [Overview of Event Enrichment](https://github.com/0xrawsec/whids/blob/master/doc/events-table.md)

**Known problems**

- Does not work correctly when running from a network share **assigned as a network drive** (this prevents whids from identifying themselves and thus generating some noise). Example: Here is the translation. Example: If \\vbox\test is mounted as the Z: drive, running Z:\whids.exe **will not work**, whereas running \\vbox\test\whids.exe **would work.**

**Path to the next release**.

- Find a new name for the project because we all agree that it sucks.
- Better sysmon integration (configuration, deployment, upgrade).
- Endpoint configuration from admin
- management of tools (upgrade, install) such as OSQuery.
- Refactoring and code optimization.
- Implement a performance monitor.
- Getting rid of any configuration on the disk.
- Implement IOC management capabilities.
- ETW support.
- Automatic documentation (OpenAPI) and API testing of the administrator.
- Provide end-point system information to the manager.
- Implement actionable rules.
- Provide canary file management.
- Integrated commands to be executed by endpoints.
- Provide incident response reports on endpoints.
- General enhancement of the administrator API.
- Providing event streams so that a client can receive real-time events.
- Standardize HTTP headers.
- Provide a Python library to interact with the EDR manager ([https://github.com/0xrawsec/pywhids](https://github.com/0xrawsec/pywhids) )

**Change Log**

**v1.7**

- New administrative HTTP API with the following features:
    - Manage endpoints (enumerate, create, delete).
    - Get basic statistics on the manager.
    - Execute commands on endpoints and get results.
        - Can drop files before execution, to run binaries/scripts that are not present on the endpoint. Dropped files are deleted after executing the command.
        - You can retrieve files (after command execution), to retrieve command results.
    - Collect endpoint files for forensic purposes.
    - Contain/discontain endpoints by restricting any network traffic except communication with the administrator.
    - Query endpoint logs.
    - Query endpoint alerts.
    - Rotate over a timestamp and retrieve logs/alerts around that time rotation.
    - Access endpoint report.
        - Scoring ( **relative to each environment** ) that allows to sort endpoints and detect those that behave differently from the others.
        - Alerts/TTPs observed in a given period.
    - Manage rules (enumerate, create, update, save, delete).
- Integration with Sysmon v12 and v13.
    - Integrate ClipboardData events.
        - Place clipboard data content within the event to allow the creation of rules on clipboard content.
    - Integrate ProcessTampering events.
        - Enrich event with different scoring between .text section on disk and in memory.
- Implemented certificate pinning on the client to improve the security of the communication channel between endpoints and the management server.
- Log filtering capabilities, allowing contextual events to be collected. Log filtering is achieved by creating Gene filtering rules (see [Gene documentation](https://github.com/0xrawsec/gene)).
- Configuration files in TOML format for better readability.
- Improved protection of the installation directory.

**Related work**

- Sysmon-based EDR written in PowerShell: [https://github.com/ion-storm/sysmon-edr](https://github.com/ion-storm/sysmon-edr)
- Comodo Open Source EDR with user and kernel components: [https://github.com/ComodoSecurity/openedr](https://github.com/ComodoSecurity/openedr)
- Sysmon X: [https://github.com/marcosd4h/sysmonx](https://github.com/marcosd4h/sysmonx)
