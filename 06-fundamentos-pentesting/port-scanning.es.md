## **Uso de herramientas de escaneo de puertos y servicios.**

### **¬øQu√© es el escaneo de puertos?**

El escaneo de puertos es un proceso mediante el cual, a trav√©s de herramientas especializadas, se analizan los puertos de un sistema inform√°tico. Al escanear puertos se puede obtener informaci√≥n como los puertos que est√°n abiertos, los que est√°n cerrados o aquellos que est√°n protegidos con cortafuegos.

Este procedimiento se puede usar con distintas finalidades. Por ejemplo, los administradores de sistemas lo emplean para conocer los servicios que est√° ofreciendo la m√°quina o para analizar el estado de los puertos y detectar y subsanar posibles vulnerabilidades.

Sin embargo, como veremos m√°s adelante, el escaneo de puertos abiertos tambi√©n se puede usar con fines poco √©ticos. Del mismo modo que los administradores de redes lo pueden usar para detectar y corregir vulnerabilidades, los ciberdelincuentes lo pueden usar para explotar dichas brechas de seguridad.

## **T√©cnicas de escaneo de puertos**

A continuaci√≥n vemos las t√©cnicas m√°s habituales para realizar un scan de puertos.

- **TCP connect() scanning:** Es una de las t√©cnicas m√°s comunes para realizar escaneos TCP y cuenta con las ventajas de que es un m√©todo muy r√°pido y que apenas requiere privilegios. B√°sicamente, consiste en usar la llamada a sistema connect(). Si se logra establecer conexi√≥n, quiere decir que el puerto est√° abierto; si no se consigue conectar, significa que el puerto est√° cerrado.
- **TCP SYN scanning**: Este m√©todo se suele denominar ‚Äúhalf-open‚Äù o mitad abierta. En realidad, no se crea una conexi√≥n TCP completa. En lugar de eso, se env√≠an paquetes SYN como si se fuera a establecer una conexi√≥n. Si se recibe como respuesta un SYN-ACK es que el puerto est√° abierto, pero si se recibe un RST es que el puerto est√° cerrado. El principal inconveniente de este m√©todo es que se requieren privilegios de ROOT para poder llevarlo a cabo.
- **TCP FIN scanning:** Es una t√©cnica de escaneo de puertos que permite penetrar en sistemas en los que los firewalls o packet filters podr√≠an detectar el uso de paquetes SYN. Usando los paquetes SYN, puede pasar que la respuesta sea un RST si el puerto est√° cerrado, y que si est√° abierto el sistema no d√© una respuesta. Con los paquetes FIN esto no ocurre.
- **Fragmentation scanning:** No se trata de un m√©todo de escaneo de puertos propiamente dicho, sino que se basa en una modificaci√≥n de t√©cnicas anteriores. Consiste en dividir o fragmentar los paquetes SYN o FIN que se env√≠an, con el objetivo de que no sean detectados por los firewall o los filtradores de paquetes.
- **TCP reverse ident scanning:** Gracias al protocolo ‚Äúident‚Äù se puede conocer el nombre de usuario y el due√±o de los servicios que se est√°n usando dentro de una conexi√≥n TCP. Para ello es necesario establecer una conexi√≥n TCP completa.
- **UDP ICMP port unreachable scanning:** Es una t√©cnica que se diferencia de las anteriores en que no se basa en el protocolo TCP, sino que usa el UDP. Este protocolo, aunque suele ser m√°s sencillo, resulta m√°s complejo a la hora de escanear puertos, por lo que el proceso se puede volver significativamente m√°s lento.

## **¬øEscanear puertos es siempre legal?**

No, el escaneo de puertos no siempre es legal. El port scanning se puede utilizar para fines leg√≠timos. Por ejemplo, para que los administradores de redes y sistemas comprueben el estado de los puertos, las conexiones y los programas o aplicaciones que est√° ofreciendo el equipo. Tambi√©n se puede usar como un m√©todo para el an√°lisis de vulnerabilidades y brechas de seguridad. Los administradores pueden escanear los puertos para crear un mapa de las conexiones y detectar posibles fallos o vulnerabilidades. Por ello, se puede decir que el escaneo de puertos es totalmente legal, siempre y cuando se tenga permiso para acceder al equipo y se realice con fines leg√≠timos.

Sin embargo, tambi√©n puede ser usado con objetivos poco √©ticos. Muchos atacantes emplean este tipo de t√©cnicas para aprovecharse de esos fallos de seguridad. Al final, los puertos abiertos pueden funcionar como una puerta de entrada a un equipo, para luego realizar otras actividades maliciosas, como ataques de denegaci√≥n de servicio.

## **Ataques de escaneo de puertos. Qu√© son y c√≥mo evitarlos**

Al hilo del punto anterior, cabe decir que los ataques de escaneo de puertos son uno de los m√©todos m√°s empleados por los crackers para descubrir vulnerabilidades en un sistema. De hecho, lo primero que har√° un cibercriminal antes de lanzar su ataque ser√° un portscan, lo que le permitir√° saber informaci√≥n como la arquitectura de la red, los servicios que ofrecemos en nuestros equipos y, por supuesto, buscar agujeros o brechas de seguridad en los mismos. Dicho de otro modo, cada puerto abierto es una potencial puerta de entrada al equipo, por lo que es necesario tomar ciertas medidas de seguridad.

Una de ellas es no abrir m√°s puertos de los necesarios, Normalmente, los equipos ya vienen con una serie de puertos abiertos predeterminados para poder ofrecer los servicios y funciones b√°sicas. Tambi√©n es aconsejable el uso de firewall o filtradores de paquetes, los cu√°les funcionan como una barrera que protege al equipo de intrusos. Otra recomendaci√≥n es mantener siempre los equipos y sistemas actualizados a su √∫ltima versi√≥n, ya que los desarrolladores suelen crear parches que subsanan posibles vulnerabilidades.

Por √∫ltimo, est√° la opci√≥n de usar herramientas como PortScanDetector, que permite detectar cu√°ndo se est√° realizando un rastreo de nuestros puertos. B√°sicamente, avisa a los administradores en aquellos casos en los que han sido consultados m√°s de 10 puertos, lo cual puede indicar que un hacker est√° intentando acceder al equipo.

El escaneo de puertos y servicios es una pr√°ctica com√∫n en pruebas de penetraci√≥n y evaluaciones de seguridad para identificar servicios activos, puertos abiertos y posibles vulnerabilidades en un sistema. Aqu√≠ hay pasos generales y algunas herramientas comunes utilizadas para realizar este tipo de escaneo:

## **Pasos Generales:**

- Definir el Alcance: Establecer el alcance de la prueba, identificando los sistemas o redes espec√≠ficas a escanear y obteniendo el consentimiento del propietario.
- Seleccionar Herramientas Apropiadas: Elegir herramientas de escaneo de puertos y servicios que se ajusten a los requisitos del proyecto y al entorno que se va a evaluar.
- Configurar Par√°metros: Configurar los par√°metros de la herramienta de escaneo, como rango de direcciones IP, rango de puertos y opciones de escaneo espec√≠ficas.
- Realizar el Escaneo: Ejecutar la herramienta de escaneo para identificar los puertos abiertos y los servicios en los sistemas objetivo.
- Analizar Resultados: Revisar los resultados del escaneo para identificar servicios, versiones de software y posibles vulnerabilidades asociadas a los puertos encontrados.
- Registrar y Documentar: Mantener registros detallados de los resultados del escaneo, incluyendo los servicios identificados, versiones y cualquier hallazgo relevante.

## **Herramientas Comunes de Escaneo de Puertos y Servicios:**

**Nmap**: Herramienta vers√°til de escaneo de puertos y mapeo de redes.

> Ejemplo de Uso: nmap -p 1-1000 192.168.1.1

**Masscan**: Esc√°ner de puertos de alto rendimiento.

> Ejemplo de Uso: masscan -p1-65535 192.168.1.1

**Unicornscan:** Herramienta de escaneo de red y puertos con enfoque en velocidad y eficiencia.

> Ejemplo de Uso: unicornscan -mU -Iv 192.168.1.1:a

**Hping3**: Herramienta avanzada de env√≠o de paquetes, √∫til para escaneo de puertos.

> Ejemplo de Uso: hping3 -S -p 80 192.168.1.1

**Netcat (nc)**: Herramienta de utilidad de red que puede utilizarse para escanear puertos.

> Ejemplo de Uso: nc -zv 192.168.1.1 1-100

Es fundamental recordar que el escaneo de puertos y servicios debe llevarse a cabo de manera √©tica y legal, con el consentimiento expl√≠cito del propietario del sistema o la red objetivo.

## **Reconocimiento y enumeraci√≥n con Nmap**

[Nmap](https://nmap.org/) es una utilidad completamente gratuita y de c√≥digo abierto, nos permite descubrir redes y host, as√≠ como realizar auditor√≠a de seguridad. Este programa es compatible con sistemas operativos Linux, Windows y tambi√©n macOS, pero en todos ellos se utiliza a trav√©s de la l√≠nea de comandos, aunque tenemos la posibilidad de instalar ZenMap que es la utilidad gr√°fica de Nmap para hacer los escaneos de puertos a trav√©s de la interfaz gr√°fica de usuario. Si no quieres pelearte con comandos a trav√©s de consola, esta interfaz gr√°fica de usuario te podr√≠a ser √∫til para los primeros pasos con este gran programa, no obstante, cuando tengas m√°s experiencia seguramente ejecutes todas las √≥rdenes directamente desde terminal.

Nmap nos permite detectar hosts de una red local, y tambi√©n a trav√©s de Internet, de esta forma, podremos saber si dichos hosts (ordenadores, servidores, routers, switches, dispositivos IoT) est√°n actualmente conectados a Internet o a la red local. Esta herramienta tambi√©n permite realizar un escaneo de puertos a los diferentes hosts, ver qu√© servicios tenemos activos en dichos hosts gracias a que nos dir√° el estado de sus puertos, podremos saber qu√© sistema operativo est√° utilizando un determinado equipo, e incluso podremos automatizar diferentes pruebas de pentesting para comprobar la seguridad de los equipos.

Nmap tiene diferentes tipos de escaneo de puertos, pueden ser a trav√©s de segmentos TCP, datagramas UDP o paquetes ICMP, adem√°s, permite realizar escaneos de forma oculta para que sean dif√≠ciles de detectar por los firewalls. Por supuesto, podremos hacer escaneo de puertos sobre ciertos puertos en concreto, entre rangos de puertos, rangos de direcciones IP, posibilidad de usar paquetes TCP null, FIN, Xmas y ACK adem√°s de SYN, para localizar los puertos TCP abiertos.

Otras caracter√≠sticas que nos brinda esta herramienta, es la posibilidad de hacer un completo inventario de red, e incluso comprobar si un determinado host o servicio sigue levantado y funcionando. Este programa fue dise√±ado para escanear una gran cantidad de hosts, por tanto, si necesitas escanear m√∫ltiples objetivos no tendr√°s problemas. Este programe es muy flexible, incorpora decenas de t√©cnicas avanzadas para escanear hosts y puertos, adem√°s, tambi√©n permite realizar auditor√≠as a trav√©s de NSE (Nmap Search Engine), por lo que es realmente potente.

<aside>
üëâ Nmap tiene varios estados en los puertos que aparecer√°n cuando hagamos un escaneo de puertos. Es fundamental saber qu√© significa cada estado de Nmap, porque con cualquier escaneo de puertos, nos devolver√° diferentes estados.

</aside>

## **Principales usos de Nmap**

Como has podido ver, Nmap es una herramienta muy vers√°til. Esta se puede utilizar para gran variedad de tareas, sobre todo relacionadas con la seguridad de la informaci√≥n. Pero tambi√©n nos permite realizar administraci√≥n de redes. Algunos de los usos m√°s comunes para Nmap son:

- **Escaneo de puertos:** Se puede utilizar para realizar el escaneo de puertos abiertos en la red. Lo cual nos da la posibilidad de identificar posibles puntos en los que un atacante puede atacar nuestra red. Tambi√©n se pueden realizar escaneos de puertos espec√≠ficos, o un rango de puertos. Lo cual nos dice los que est√°n abiertos, y como tal, con posibilidad de ser atacados.
- **Detecci√≥n de sistemas:** Nmap se puede utilizar para encontrar sistemas activos en una red. Esto puede incluir servidores y dispositivos de red. Esto se hace escaneando una direcci√≥n IP, o un rango de direcciones para identificar los dispositivos en la red.
- **Detecci√≥n de servicios:** Con Nmap es posible detectar los servicios que se est√°n ejecutando en la red, lo cual nos ayuda en muchos casos a detectar vulnerabilidades. Podremos identificar servicios como HTTP, Telnet, FTP, SSH, entre otros muchos. Esto lo que permite es proporcionar informaci√≥n muy detallada sobre los softwares que est√°n siendo ejecutados, incluso las versiones de los mismos.
- **Mapeo de redes:** Se puede utilizar para mapear redes. Esto puede incluir varios factores como la ubicaci√≥n de un dispositivo o la topolog√≠a de la propia red. As√≠ ser√° mucho m√°s sencillo crear un mapa visual de toda la infraestructura, identificando los dispositivos y como est√°n conectados.
- **Pruebas de seguridad:** Con Nmap se pueden realizar pruebas de penetraci√≥n y evaluaciones de seguridad. Esto nos permite identificar vulnerabilidades en los sistemas o la red. Esto est√° directamente ligado al escaneo de puertos.
- **Monitorizaci√≥n:** Nmap tiene la capacidad de realizar una monitorizaci√≥n de la disponibilidad de los servidores o dispositivos de la red. Lo cual nos ayuda a ver si est√°n funcionando de la forma correcta.

## **Para que escanear puertos**

Como hemos visto, con nmap tenemos una herramienta especializada en analizar los puertos de los sistemas inform√°ticos, obteniendo informaci√≥n sobre si est√°n abiertos, cerrados o protegidos con cortafuegos. Esto se puede hacer con multitud de finalidades, como saber qu√© servicios se est√°n ofreciendo desde un equipo por los administradores o por seguridad, buscando solventar alg√∫n problema que pueda llegar en forma de vulnerabilidad.

Pero esto tambi√©n se puede utilizar con fines maliciosos. Igual que los Administradores pueden analizarlos para buscar posibles vulnerabilidades, un atacante puede hacerlo por exactamente lo mismo, pero con la intenci√≥n de aprovecharse de ello para infiltrarse en la red aprovechando una brecha en la seguridad.

## **Estado de los puertos con Nmap**

- **Open**: una aplicaci√≥n est√° activamente aceptando conexiones TCP o UDP. El puerto est√° abierto y se puede utilizar, los pentesters podr√°n utilizar este puerto abierto para explotar el sistema. Es el estado por defecto si no tenemos ning√∫n firewall bloqueando accesos.
- **Closed**: un puerto que est√° cerrado es accesible porque responde a Nmap, sin embargo, no hay ninguna aplicaci√≥n funcionando en dicho puerto. Es √∫til para descubrir que un host est√° levantado, o como parte de la detecci√≥n de un sistema operativo. De cara al administrador del sistema, es recomendable filtrar estos puertos con el firewall para que no sean accesibles. De cara al pentester, es recomendable dejar estos puertos ‚Äúcerrados‚Äù para analizar m√°s tarde, por si ponen alg√∫n servicio nuevo.
- **Filtered**: en este estado Nmap no puede determinar si el puerto est√° abierto, porque hay un firewall filtrando los paquetes de Nmap en dicho puerto. Estos puertos filtrados son los que aparecer√°n cuando tengamos un firewall activado. Nmap intentar√° en varias ocasiones intentar conectar, lo que hace que el escaneo de puertos sea bastante lento.
- **Open/Filtered**: Nmap no sabe si el puerto est√° abierto o filtrado. Esto ocurre porque el puerto abierto no env√≠a ninguna respuesta, y dicha falta de respuesta podr√≠a ser por el firewall. Este estado aparece cuando usamos UDP y IP, y utilizamos escaneos FIN, NULL y Xmas.
- **Closed/Filtered**: en este estado no se sabe si el puerto est√° cerrado o filtrado. Solo se usa este estado en el IP Idle Scan.

# **Efectividad de Nmap**

Nmap es una herramienta que se considera altamente efectiva. Esto se debe a una combinaci√≥n de funcionalidad y caracter√≠sticas avanzadas, que hace de esta soluci√≥n una de las mejores que podemos encontrarnos. Esta cuenta con la capacidad de realizar escaneos de vulnerabilidades, para identificar posibles debilidades en las configuraciones de los sistemas de seguridad. Por lo cual, de no ser efectiva, no ser√≠a una herramienta tan conocida. Por lo cual podr√≠amos decir, que la propia fama de Nmap es un buen identificativo para la calidad que puede proporcionarnos en una gran variedad de situaciones diferentes.

Por otro lado, m√°s all√° de su eficacia en identificaci√≥n de dispositivos, servicios y vulnerabilidades, est√° su capacidad para trabajar con diferentes protocolos de red. Entre otros, TCP, UDP, ICMP e IP. Todo lo cual, se puede integrar con otras herramientas de seguridad y an√°lisis. Pueden ser herramientas como Metasploit o incluso Wireshark. Lo cual hace de Nmap una herramienta muy vers√°til para todo tipo de sistemas.

En cambio, no estamos ante una soluci√≥n que sea perfecta, ni que represente una medida de seguridad ante problemas. A pesar de que es muy efectiva y poderosa, requiere de cierto conocimiento por parte de los usuarios que la utilicen. As√≠ como la disposici√≥n de las habilidades necesarias para darle uso con todas las garant√≠as, y aprovechando su rendimiento y funciones al m√°ximo. Tambi√©n debemos pensar que muchos dispositivos pueden contar con alg√∫n tipo de protecci√≥n contra los escaneos de las aplicaciones como Nmap, o pueden incluso ser complicados de detectar. Pero en estos casos, ya no ser√≠a un problema de la eficiencia de Nmap ni de sus funciones, sino de las medidas de protecci√≥n establecidas en esos dispositivos. En todo caso, si buscamos una soluci√≥n efectiva, fiable y con buena trayectoria, Nmap es una de las mejores soluciones actualmente.

## **Personalizaci√≥n de NMAP**

Como puedes ver, con NMAP estamos ante una herramienta de c√≥digo abierto, por lo cual tiene una alta capacidad de personalizaci√≥n. Lo cual la lleva a ser una soluci√≥n altamente adaptable a las necesidades de cada usuario, en todo tipo de escenarios. Pero esto es algo que no se realiza a la ligera, sino que hay algunos factores que destacan por encima de otros. Empezando por las opciones de escaneo, donde la gama de opciones es muy amplia. Esta permite gestionar muchos par√°metros y opciones avanzadas, que modifican por completo el funcionamiento de NMAP. El escaneo personalizado, permite disponer de informaci√≥n muy valiosa, y de todo tipo al realizar an√°lisis de puertos, por ejemplo.

Por otro lado, est√°n los scripts NSE (Nmap Scripting Engine). Esta es una de las caracter√≠sticas m√°s potentes de NMAP, la cual permite ejecutar scripts muy personalizados durante el tiempo de escaneo. Al poder crear los scripts por nuestra parte, pueden ser todo lo complejos que sea necesario. Y como tal nos da ese a√±adido en personalizaci√≥n, el cual no tendr√≠amos sin esta secci√≥n de NMAP. Todo se hace buscando la salida personalizada de datos, donde se pueden establecer muchos par√°metros. Desde el formato de salida, generar informes HTML, y los resultados que vamos a necesitar que incluya el an√°lisis que se realiza en la red.

Por √∫ltimo, NMAP cuenta con una gran capacidad de integraci√≥n con otras herramientas. Una de las caracter√≠sticas m√°s llamativas, es el poder establecer NMAP como entrada para otras herramientas de seguridad que utilicemos, o incluso para detecci√≥n de intrusos. Lo cual, de nuevo, se puede combinar con los scripts que mencionamos previamente. Una vez que hemos visto las principales caracter√≠sticas de Nmap, y el estado de los puertos que tenemos disponibles, vamos a instalarlo y utilizarlo.

## **Descarga e instalaci√≥n de Nmap en cualquier sistema**

Lo primero que tenemos que hacer para utilizar este programa tan potente, es descargarlo y posteriormente instalarlo. En la **[secci√≥n de descargas de Nmap](https://nmap.org/download.html)** pod√©s encontrar todos los enlaces, binarios y c√≥digo fuente para su instalaci√≥n en sistemas operativos Windows, Linux y MacOS. Este programa, actualmente lo tenemos disponible en todos los repositorios de los sistemas operativos basados en Linux, por lo que su instalaci√≥n es realmente sencilla. En Kali Linux ya viene instalado, pero si en tu Linux no esta instalado simplemente ejecutando la orden de instalaci√≥n seguido de ¬´nmap¬ª, instalaras el programa sin dificultades.

`sudo apt install nmap`

## **Ejemplos de uso de Nmap**

Nmap es un programa muy avanzado y complejo, con decenas de comandos y ataques que vamos a poder realizar, con el objetivo de descubrir todos los hosts que tengamos en una red local dom√©stica o profesional, adem√°s, tambi√©n es capaz de detectar hosts en Internet, es decir, vamos a poder escanear uno a uno cualquier direcci√≥n IP de Internet e incluso subredes que sean p√∫blicas.

Una vez que hemos descubierto que el host est√° online, se le puede realizar un escaneo r√°pido de puertos y comprobar si tiene un firewall filtrando todos los paquetes, o bien tenemos un puerto abierto para poder explotar alguna vulnerabilidad. Nmap permite utilizar tanto direcciones IPv4 privadas y p√∫blicas, como tambi√©n direcciones IPv6, con el objetivo de poder escanear los puertos de cualquier host.

A continuaci√≥n, veremos algunos ejemplos de c√≥mo se utiliza Nmap a nivel usuario, y tambi√©n con comandos algo m√°s avanzados, y es que este programa nos permitir√° descubrir con cierta exactitud qu√© sistema operativo est√° utilizando el host remoto, ideal para obtener la m√°xima informaci√≥n posible.

## **Escaneo r√°pido de puertos**

Si quieres realizar un escaneo r√°pido de puertos a un determinado host, debemos teclear el siguiente comando. Este comando b√°sico se encargar√° de escanear los principales puertos a la direcci√≥n IP privada o p√∫blica definida, un detalle muy importante es que no escanear√° todos los puertos, sino los m√°s utilizados habitualmente.

> nmap [ip]

Por ejemplo, si queremos realizar un escaneo r√°pido de los principales puertos a un host con direcci√≥n IP 192.168.1.1, la orden ser√≠a la siguiente:

> nmap 192.168.1.1

El programa nos devolver√° los puertos que se encuentran abiertos en el equipo objetivo.

![Nmap escaneo](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/nmap-escaneo.png?raw=true)

En el caso de querer escanear todos y cada uno de los puertos tendremos que recurrir al siguiente comando y poner un rango desde el puerto 1 hasta el 65535, de esta forma estaremos comprobando si todos y cada uno de los puertos est√°n abiertos, cerrados o filtrados.

## **Realizar escaneo de un rango de puertos**

En lugar de realizar un escaneo de todos los puertos, podemos establecer un rango de puertos a comprobar. Para ello ejecutaremos:

> nmap -p [rango] [ip]

Si queremos realizar un escaneo de puertos desde el 20 TCP hasta el 200 TCP en la direcci√≥n IP 192.168.1.1, basta con ejecutar la siguiente orden:

> nmap -p 20-200 192.168.1.1
> 

El programa nos indicar√° dentro de ese rango qu√© puertos est√°n abiertos.

![Rango cuerpos](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/rango-cuerpos.png?raw=true)

Dependiendo de la latencia de la conexi√≥n entre nuestro equipo y el host remoto, y tambi√©n el n√∫mero de puertos a analizar, este proceso podr√≠a durar desde varios segundos hasta unos 10 minutos aproximadamente.

## **Detectar el sistema operativo y m√°s datos del host**

Podemos indicar a Nmap que detecte el sistema operativo. Esto lo realiza enviando paquetes y analizando la forma en que los devuelve, siendo en cada sistema totalmente diferente. Junto a esto, realizar√° una exploraci√≥n de puertos y de los servicios en busca de vulnerabilidades. Asimismo, el escaneo devolver√° informaci√≥n √∫til. Para ello debemos ejecutar:

> nmap -A -v [ip]

Si queremos realizar este escaneo a la direcci√≥n IP 192.168.1.1 podemos ejecutar la siguiente orden:

> nmap -A -v 192.168.1.1

Esta prueba de detecci√≥n del sistema operativo no es del todo fiable porque depende de muchos par√°metros, en algunos casos la exactitud es muy buena, sobre todo en diferenciar si es Windows o Linux, pero dentro del mundo Linux es realmente complicado conocer qu√© sistema operativo es en concreto.

![usuario operativo](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/usuario-operativo.png?raw=true)

# **Listado de todos los comandos**

Este programa es realmente completo, hasta el momento hemos utilizado los comandos b√°sicos para descubrir hosts y tambi√©n para ver si tiene los puertos abiertos, sin embargo, esto no se queda as√≠, y tenemos un gran listado de comandos para exprimir al m√°ximo esta herramienta.

### **Seleccionar objetivos**

Direcciones o rangos IP, nombres de sistemas, redes, etc.

- **Ejemplo:** scanme.nmap.org, microsoft.com/24, 192.168.0.1, 10.0.0-255.1-254
- **iL** fichero lista en fichero -iR n elegir objetivos aleatoriamente, 0 nunca acaba
- **‚Äìexclude ‚Äìexcludefile** fichero excluir sistemas desde fichero

### **Descubrir sistemas**

- **PS** n tcp syn ping
- **PA** n ping TCP ACK
- **PU** n ping UDP
- **PM** Netmask Req
- **PP** Timestamp Req
- **PE** Echo Req
- **sL** an√°lisis de listado
- **PO** ping por protocolo
- **PN** No hacer ping
- **n** no hacer DNS
- **R** Resolver DNS en todos los sistemas objetivo
- **‚Äìtraceroute**: trazar ruta al sistema (para topolog√≠as de red)
- **sP** realizar ping, igual que con ‚ÄìPP ‚ÄìPM ‚ÄìPS443 ‚ÄìPA80

## **T√©cnicas de an√°lisis de puertos**

En la mayor√≠a de ocasiones, cuando los usuarios est√°n empezando a utilizar esta herramienta, lo m√°s probable es que intenten la resoluci√≥n de la mayor√≠a de problemas con el tipo de escaneo SYN porque es uno de los m√°s vers√°tiles. Pero, a medida que avanzan y conocen la herramienta en profundidad, se dar√°n cuenta de que ampliar√°n su abanico de soluciones y aqu√≠ abajo explicamos un poco algunos de los comandos que resultan m√°s √∫tiles al momento de analizar puertos.

- **sS an√°lisis utilizando TCP SYN:** Este tipo de escaneo, est√° basado en la velocidad de escaneo, de ah√≠ la versatilidad que mencionamos anteriormente, ya que permite escanear miles de puertos por segundo en una red que se encuentre desprotegida o carezca de un firewall. Adem√°s, en lo que a t√©rminos de privacidad se refiere, es una excelente t√©cnica, ya que no llega a completar las conexiones TCP y por lo tanto no llama la atenci√≥n.
- **sT an√°lisis utilizando TCP CONNECT:** Este tipo de exploraci√≥n, podr√≠amos decir que es la que se utiliza principalmente, sobre todo cuando no podemos ejecutar un escaneo tipo SYN, este tipo de an√°lisis de conexi√≥n, lo que hace es realizar o emitir una llamada al sistema de conexi√≥n para que se establezca una conexi√≥n con la red que estamos analizando. Luego, Nmap lo que hace es utilizar esta llamada para analizar la informaci√≥n sobre cada intento de conexi√≥n, la principal desventaja de este tipo de an√°lisis es que nos toma un poco m√°s de tiempo identificar los puertos que est√°n abiertos que nos llevar√≠a por ejemplo con el SYN.
- **sU an√°lisis utilizando UDP:** Este tipo de escaneo es bastante simple, suele utilizarse sobre todo cuando queremos realizar un seguimiento de puertos como los DNS, SNMP y DHCP en nuestra red. Por supuesto, que sea sencillo no quita que son puertos bastante importantes, ya que suelen ser las √°reas por donde suelen haber atacantes buscando vulnerabilidades para explotar.
- **sY** an√°lisis utilizando SCTP INIT
- **sZ** utilizando COOKIE ECHO de SCTP
- **sO** protocolo IP
- **sW** ventana TCP -sN
- **‚ÄìsF -sX** NULL, FIN, XMAS
- **‚ÄìsA** TCP ACK

### **Puertos a analizar y orden de an√°lisis**

- **p n-m** rango
- **p‚Äì** todos los puertos
- **p n,m,z** especificados
- **p U:n-m,z T:n,m** U para UDP, T para TCP
- **F** r√°pido, los 100 comunes
- **‚Äìtop-ports n** analizar los puertos m√°s utilizados
- **r** no aleatorio

### **Duraci√≥n y ejecuci√≥n:**

- **T0** paranoico
- **T1** sigiloso
- **T2** sofisticado
- **T3** normal
- **T4** agresivo
- **T5** locura
- **‚Äìmin-hostgroup**
- **‚Äìmax-hostgroup**
- **‚Äìmin-rate**
- **‚Äìmax-rate**
- **‚Äìmin-parallelism**
- **‚Äìmax-parallelism**
- **‚Äìmin-rtt-timeout**
- **‚Äìmax-rtt-timeout**
- **‚Äìinitial-rtt-timeout**
- **‚Äìmax-retries**
- **‚Äìhost-timeout ‚Äìscan-delay**

**Detecci√≥n de servicios y versiones:**

- **sV:** detecci√≥n de la versi√≥n de servicios
- **‚Äìall-ports** no excluir puertos
- **‚Äìversion-al**l probar cada exploraci√≥n
- **‚Äìversion**trace rastrear la actividad del an√°lisis de versi√≥n
- **O** activar detecci√≥n del S. Operativo
- **‚Äìfuzzy** adivinar detecci√≥n del SO
- **‚Äìmax-os-tries** establecer n√∫mero m√°ximo de intentos contra el sistema objetivo

**Evasi√≥n de Firewalls/IDS**

- f fragmentar paquetes
- **D d1,d2** encubrir an√°lisis con se√±uelos
- **S ip** falsear direcci√≥n origen
- **‚Äìg source** falsear puerto origen
- **‚Äìrandomize-hosts** orden
- **‚Äìspoof-mac mac** cambiar MAC de origen

**Par√°metros de nivel de detalle y depuraci√≥n**

- **v** Incrementar el nivel de detalle
- **‚Äìreason** motivos por sistema y puerto
- **d (1-9)** establecer nivel de depuraci√≥n
- **‚Äìpacket-trace** ruta de paquetes

**Otras opciones**

- **‚Äìresume file** continuar an√°lisis abortado (tomando formatos de salida con -oN o -oG)
- **6** activar an√°lisis IPV6
- **A** agresivo, igual que con -O -sV -sC ‚Äìtraceroute

**Opciones interactivas**

- **v/V** aumentar/disminuir nivel de detalle del an√°lisis
- **d/D** aumentar/disminuir nivel de depuraci√≥n
- **p/P** activar/desactivar traza de paquetes

**Scripts**

- **sC** realizar an√°lisis con los scripts por defecto
- **‚Äìscript file** ejecutar script (o todos)
- **‚Äìscript-args n=v** proporcionar argumentos
- **‚Äìscript-trace** mostrar comunicaci√≥n entrante y saliente

**Formatos de salida**

- **oN** guardar en formato normal
- **oX** guardar en formato XML
- **oG** guardar en formato para posteriormente usar Grep
- **oA** guardar en todos los formatos anteriores

<aside>
üí° Principalmente estos son los comandos de que dispone Nmap. Antes de terminar, debemos decir que Nmap dispone de multitud de opciones con las que poder realizar completos an√°lisis de redes. Podemos consultar todas las opciones disponibles tecleando:
</aside>

> nmap --help

![nmap help](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/nmap-help.png?raw=true)

Nmap es sin duda una herramienta muy sencilla y completa para realizar auditor√≠as de redes, pero esto no acaba aqu√≠, tambi√©n tenemos disponible Nmap NSE para realizar pentesting avanzados.

**Otras t√©cnicas de escaneo**

Como hemos visto, nmap ofrece muchos par√°metros para realizar un escaneo m√°s a medida, pero actualmente existen otros m√©todos para realizar esta tarea los cuales pueden ser interesantes. Cada uno de ellos tiene sus propias caracter√≠sticas, y pueden variar en efectividad.

- **TCP connect()scanning:** Es una de la formas de escaneo m√°s comunes, porque es r√°pido y no son necesarios demasiados privilegios en el equipo.
- **TCP SYN scanning:** Tambi√©n conocido como ¬´half-open¬ª. Este no llega a crear una conexi√≥n TCP, si no que utiliza el env√≠o de paquetes SYN. Puede obtener dos respuestas diferentes, un SYN-ACK que indica que el puerto est√° abierto, y un RST que est√° cerrado.
- **TCP FIN scanning:** Permite realizar escaneos de puertos en aquellos sistemas que cuentan con firewalls o filtros de paquetes SYN.
- **Fragmentation Scanning:** Aqu√≠ no estamos ante un escaneo como tal, sino que est√° para modificar las t√©cnicas anteriores mediante la divisi√≥n o fragmentaci√≥n de paquetes SYN o FIN. Esto se hace para que no sean detectados por firewall o filtros de paquetes.
- **TCP reverse ident scanning:** Con este identificador, es posible conocer datos sobre el responsable de los servicios que est√°n usando una determinada conexi√≥n TCP. Requiere una conexi√≥n completa.

> Gracias a estas t√©cnicas de escaneo avanzadas, pordemos determinar si los puertos est√°n abiertos o cerrados.

# **Nmap NSE: qu√© es y para qu√© sirve**

**Nmap Search Engine** o tambi√©n conocido como **Nmap NSE**, es una gran base de datos con miles de scripts que nos permitir√° automatizar la realizaci√≥n de pentesting a sistemas y redes. El primer paso de cualquier pentesting es realizar un escaneo de puertos, una vez realizado este escaneo de puertos, podremos intentar explotar vulnerabilidades en los servicios que hay funcionando detr√°s de un determinado puerto, por ejemplo, podr√≠amos atacar servidores web, servidores Samba, FTP, servidores SSH, servidores DNS, comprobar si los diferentes servicios tienen vulnerabilidades conocidas o directamente intentar autenticarnos en ellos, si es que tienen autenticaci√≥n como en el FTP o SSH.

NMAP NSE es un conjunto de scripts que nos permitir√° automatizar muchas acciones, como realizar ataques de fuerza bruta a servidores Samba, con el objetivo de intentar acceder a ellos y hacernos con el control, aunque tambi√©n podr√≠amos atacarlo para realizarle un ataque de denegaci√≥n de servicio y que el servicio no est√© disponible. Lo mismo podr√≠amos hacer con los servidores FTP, servidores SSH y mucho m√°s, sobre todo, los servidores web que deben tener un puerto abierto en el firewall son los que m√°s se deben proteger para evitar o mitigar los ataques que nos puedan realizar.

Por ejemplo, si queremos realizar un ataque de fuerza bruta, basado en un listado de usuarios (con un archivo que se llame usuarios.txt) y con un listado de contrase√±as a probar (con un archivo que se llame claves.txt) a un servidor SSH de un determinado equipo que tiene la IP 192.168.25.01, podemos poner el siguiente comando:

> nmap -p 22 --script ssh-brute --script-args userdb=usarios.txt,passdb=claves.txt --script-args ssh-brute.timeout=4s 192.168.25.01

Si queremos saber si un servidor FTP tiene habilitado la autenticaci√≥n an√≥nima, podremos hacerlo f√°cilmente poniendo la siguiente orden:

> nmap -sV -sC -p21 192.168.25.01

si queremos realizar un ataque de fuerza bruta a un servidor FTP a un servidor con la IP 99.99.99.99, podemos poner el siguiente comando:

> nmap -p 21 --script ftp-brute 192.168.25.01

Disponemos de una grand√≠sima cantidad de scripts dentro de Nmap NSE con el objetivo de comprobar la seguridad de decenas de servicios, porque no solamente tendremos los t√≠picos de servidores Samba, FTP, SSH y m√°s, sino que tambi√©n podremos atacar de forma muy concreta un servidor web con cabeceras HTTP especiales para ver si hay vulnerabilidades, por supuesto, tendremos scripts espec√≠ficos que nos permitir√° explotar vulnerabilidades al PHP de los servidores web, por supuesto, tambi√©n podremos explotar vulnerabilidades a los diferentes servidores Samba, FTP y SSH, es decir, vulnerabilidades conocidas que ya han sido solucionadas, pero que es posible que todav√≠a el objetivo las tenga operativas. Por este motivo es tan importante actualizar cuanto antes todos los servicios que tengamos expuestos a Internet, y tambi√©n servicios que tengamos expuestos a la red local, porque con un malware podr√≠a explotar una vulnerabilidad y convertirse el ataque de penetraci√≥n en un ataque de ransomware para cifrar todos los archivos y carpetas.

Recomiendo visitar la **[web oficial de uso de NSE](https://nmap.org/book/nse-usage.html)** donde encontr√°s todos los scripts que hay actualmente en esta gran base de datos, adem√°s, tendr√°s ejemplos de c√≥mo utilizarlos.

# **Zenmap, la interfaz gr√°fica de Nmap**

Zenmap es una herramienta gratuita que podemos utilizar para **escanear los puertos**. Podemos saber cu√°les tenemos abiertos, para evitar problemas a la hora de usar algunos programas o acceder a un servidor. Se trata de la interfaz gr√°fica del popular programa de c√≥digo abierto Nmap, que permite hacer un escaneo de puertos completo de cualquier equipo conectado. Hay que indicar que esta herramienta, que es totalmente gratuita, est√° disponible para **diferentes sistemas operativos** como Microsoft Windows, Linux o macOS. Permite a los usuarios ejecutar diferentes tipos de an√°lisis de puertos. Es ideal tanto para usuarios menos experimentados como tambi√©n para los m√°s avanzados.

Para comenzar a utilizar Zenmap lo primero que tenemos que hacer es **descargarlo**. Podemos hacerlo desde la [p√°gina oficial](https://nmap.org/download.html) de Nmap. All√≠ encontraremos las diferentes versiones, seg√∫n el sistema operativo que estemos utilizando. El proceso de instalaci√≥n es sencillo, r√°pido e intuitivo. En unos segundos lo tendremos listo para utilizar.

![zenmap](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/zenmap.png?raw=true)

Cuando lo hayamos instalado simplemente tendremos que ejecutarlo. Nos encontraremos con una imagen como la de arriba. Podemos elegir un escaneo de puertos a fondo, escaneo r√°pido, puertos TCP, UDP, etc. Con Zenmap podemos ver **qu√© puertos hay abiertos** en cualquier dispositivo. En el apartado de Objetivo tenemos que poner la direcci√≥n IP que corresponde a ese equipo para, posteriormente, realizar el escaneo para que muestre cu√°les est√°n abiertos. Por tanto lo primero que tenemos que hacer es saber **cu√°l es la direcci√≥n IP** de nuestro equipo.

En Windows este proceso es muy sencillo. Simplemente tenemos que ir a Inicio, ejecutamos el S√≠mbolo del sistema y posteriormente ipconfig. Nos mostrar√° una serie de informaci√≥n entre las que podemos ver la puerta de enlace predeterminada (generalmente 192.168.1.1) as√≠ como la direcci√≥n IP de ese equipo. Cuando sepamos cu√°l es la direcci√≥n tendremos que ponerla en el apartado de Objetivo, en Zenmap. Posteriormente tendremos que elegir el tipo de escaneo que queremos realizar, como podr√≠a ser por ejemplo un escaneo completo de todos los puertos TCP.

![Puertos TCP](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/puertos-tcp.png?raw=true)

En Zenmap, en la parte de arriba, encontraremos **diferentes pesta√±as**. Veremos Salida Nmap, Puertos/Servidores, Topolog√≠a, Detalles del servidor y Escaneos. Todos ellos nos aporta informaci√≥n, as√≠ como poder elegir el tipo de servicio en la parte de la izquierda. Cuando le damos a Puertos/Servidores nos aparecer√° una recopilaci√≥n de todos los puertos abiertos y filtrados que hay en ese host. Hay que tener en cuenta que nos aparecer√°n m√°s o menos puertos en funci√≥n del tipo de escaneo que hayamos realizado.

![Salida Nmap](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/salida-nmap.png?raw=true)

Si pinchamos en **Escaneos** nos aparecer√°n todos los escaneos que hemos realizado. Los podemos guardar para poder analizar los datos en otra ocasi√≥n, as√≠ como tambi√©n eliminarlos y que no aparezcan ah√≠.

Esto lo podemos hacer con cualquier otro equipo que tengamos conectado a la red. Por ejemplo, podemos comprobar tambi√©n los **puertos abiertos** y hacer un escaneo a nuestro tel√©fono m√≥vil. √önicamente vamos a necesitar conocer cu√°l es la direcci√≥n IP. Eso s√≠, hay que tener en cuenta que este proceso puede tardar m√°s o menos seg√∫n el tipo de dispositivo.

En definitiva, Zenmap es un programa interesante con el que podemos hacer escaneos de puertos. Lo podemos usar en Windows, que es el sistema operativo m√°s utilizado en equipos de escritorio, as√≠ como en Linux y macOS. Su uso es sencillo e intuitivo y podremos tener un mayor control sobre qu√© puertos tenemos abiertos, especialmente cuando necesitamos conocer si un equipo va a funcionar correctamente al hacer uso de alguna aplicaci√≥n que requiera de ciertos puertos abiertos.

## **Implementaci√≥n en empresas**

Muchas empresas deciden implementar estos sistemas para tener un poco m√°s de control sobre sus redes. Pero esto es algo que se debe estudiar de forma detenida, y siguiendo unos pasos para que todo el proceso sea totalmente eficiente. Estos pasos son:

- **Evaluaci√≥n de necesidades:** Siempre y cuando se implemente un nuevo sistema en una empresa, es necesario realizar una evaluaci√≥n de las necesidades que vamos a tener dentro de la organizaci√≥n. Tendremos que identificar los objetivos, los activos cr√≠ticos de la red, y todos y cada uno de los requisitos de seguridad que vamos a necesitar solucionar con NMAP.
- **Instalaci√≥n y configuraci√≥n:** En cualquier entorno, lo m√°s recomendable es acudir siempre a los sitios oficiales para obtener la herramienta. Esto har√° que el proceso sea totalmente seguro. Una vez disponemos de ella, tendremos que configurar correctamente los ajustes y opciones en NMAP para que esta cumpla con los requisitos espec√≠ficos.
- **Pol√≠ticas y procedimientos:** Las pol√≠ticas que se establezcan en NMAP, deben ser claras y concisas. Aqu√≠ podremos configurar los escaneos y los tipos, as√≠ como los protocolos de notificaci√≥n y reporte de hallazgos.
- **Capacitaci√≥n:** Todo el personal que utilice NMAP, debe estar correctamente formado y capacitado para utilizarlo. Ser√° necesario comprender c√≥mo se utiliza la herramienta de forma segura y efectiva, y que siempre deben estar al tanto de todas las pol√≠ticas y procedimientos.
- **An√°lisis:** Como es normal, NMAP nos va a dar unos resultados. Estos deben ser analizados, y como tal ser√° necesario tener un procedimiento para ello. Esto har√° que el an√°lisis sea mucho m√°s efectivo, y tengamos la informaci√≥n adecuada en todo momento.
- **Actualizaciones:** Una vez disponemos de la herramienta instalada y configurada, tendremos que establecer la forma en la cual vamos a mantenerla actualizada. Esto es algo cr√≠tico, ya que ser√° necesario para que todo se mantenga lo m√°s segura posible y con el funcionamiento m√°s √≥ptimo.

<aside>
üëâ Como podemos ver, Nmap es una herramienta tremendamente √∫til, que nos puede dar muchas facilidades a la hora de gestionar redes.

</aside>

