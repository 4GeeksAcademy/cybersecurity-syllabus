# NMAP - Script firewall-bypass

Firewalls, particularly those that use protocol helpers to dynamically open ports for certain protocols, such as FTP (File Transfer Protocol) and SIP (Session Initiation Protocol), are potentially vulnerable. For example, FTP uses a control connection on one port (usually port 21) and a separate data connection on another port. The firewall needs to open the appropriate data port for the dynamic transfer.

### Netfilter:

Netfilter is a widely used packet filtering framework in Linux, and it's commonly used in firewalls like iptables.
The vulnerability discussed here is specific to how these firewalls handle dynamic port opening through helpers.

### The Vulnerability:

The vulnerability arises because the firewall relies on spoofable network information to determine whether to open a port. An attacker could exploit this by crafting a packet that appears to come from a legitimate source (spoofing).

The firewall's helper mechanism could be tricked into opening a port based on this spoofed packet, allowing the attacker to bypass the firewall‚Äôs security mechanisms and potentially gain unauthorized access or launch further attacks.

## How the Attack Works:

> üî• We are going to `spoof` the packet:

The attacker sends a packet that appears to be from the target server. This packet requests the firewall to open a related connection to a specific target port.
Since the packet is spoofed to look like it's coming from the server, the firewall's protocol helper might believe it's a legitimate request and open the port, thus compromising security.

> ü§ö The attacking machine must be on the same network segment as the firewall to successfully spoof the packet. Being on the same segment means the attacker can easily monitor and craft packets that match the network traffic expected by the firewall.


## Using the NMAP Scripting Engine

We can use the Nmap Scripting Engine to write and execute scripts for automated network discovery and vulnerability detection. The script detects a vulnerability in Netfilter and other firewalls that use helpers to dynamically open ports for protocols like FTP and SIP. 

The script works by spoofing a packet from the target server requesting to open a related connection to a target port that the firewall will fulfil via the appropriate protocol helper port. The attacking machine must be on the same network segment as the firewall for this to work. The script supports the FTP helper in both IPv4 and IPv6. The real path filter is used to prevent such attacks.

> üî• Download the script [firewall-bypass.nse](https://svn.nmap.org/nmap/scripts/firewall-bypass.nse), you can [read more about the script here](http://home.regit.org/2012/03/playing-with-network-layers-to-bypass-firewalls-filtering-policy/)**

**Arguments**

- firewall-bypass.helper

- The helper to use. The default is ftp. Supported helpers: ftp (both IPv4 and IPv6).

**firewall-bypass.targetport**

Port to test the vulnerability. The target port must be a non-open port. If not provided, the script will attempt to find a filtered or closed port from the port scan results.

**firewall-bypass.helperport**

> If you do not use the wizard's default port.

**examples**

```bash
nmap --script firewall-bypass <target>

nmap --script firewall-bypass --script-args firewall-bypass.helper=‚Äúftp‚Äù, firewall-bypass.targetport=22 <target>
```

**output**

```bash
Host script results:

| Firewall omission:

|_ Firewall vulnerable to omission via ftp wizard (IPv4)
```

